@model IEnumerable<SAG2.Models.Movimiento>
@using SAG2.Models;
@{
    Layout = null;
    ViewBag.Title = "Conciliación Bancaria";
    SAG2.Classes.Util utils = new SAG2.Classes.Util();
    Response.Clear();
    Response.Buffer = true;
    Response.ContentType = "application/vnd.ms-excel";
    Response.AddHeader("Content-Disposition", "attachment;filename=Conciliacion.SAG.2.0-" + DateTime.Now.ToShortDateString() + ".xls");
    SAG2.Models.SAG2DB db = new SAG2.Models.SAG2DB();
    int cantidad = 18;
    var Saldo = 0;
    if (@ViewBag.SaldoInicial != null && !@ViewBag.SaldoInicial.Equals("0"))
    {
        Saldo = Int32.Parse(@ViewBag.SaldoInicial.ToString());
    }

    int PeriodoSeleccionado = (int)@ViewBag.periodo;
    int mesSeleccionado = (int)@ViewBag.mes;
    CuentaCorriente CuentaCorriente = (CuentaCorriente)@ViewBag.cuentaCorriente;
}
<style>
	body, table, tr, td {
		font-family: Arial Unicode MS, Arial, Helvetica, sans-serif;
		font-size: 10pt;	
	}
</style>
</head>

<body>
<table border="0">
	<tr>
		<td colspan="5" align="center" style="text-decoration: underline;"><strong>CUENTA {NUMERO} BANCO @CuentaCorriente.Banco.Nombre</strong></td>
	</tr>
	<tr>
		<td colspan="5" align="center" style="text-decoration: underline;"><strong>CTA. CTE. N° @CuentaCorriente.Numero</strong></td>
	</tr>
	<tr>
		<td width="93" style="width: 93px;">&nbsp;</td>
		<td width="80" style="width: 80px;">&nbsp;</td>
		<td width="290" style="width: 290px;">&nbsp;</td>
		<td width="60" style="width: 60px;">&nbsp;</td>
		<td width="105" style="width: 105px;">&nbsp;</td>
	</tr>
	<tr>
		<td>&nbsp;</td>
		<td>&nbsp;</td>
		<td>&nbsp;</td>
		<td>&nbsp;</td>
		<td>&nbsp;</td>
	</tr>
	<tr>
		<td>&nbsp;</td>
		<td>&nbsp;</td>
		<td>&nbsp;</td>
		<td>&nbsp;</td>
		<td>&nbsp;</td>
	</tr>
	<tr>
		<td colspan="3"><strong>SALDO SEGÚN BALANCE AL @ViewBag.Fecha</strong></td>
		<td>&nbsp;</td>
		<td><strong><span style="text-decoration: underline;">$@Html.Raw(Saldo.ToString("#,##0"))</span></strong></td>
	</tr>
	<tr>
	  <td colspan="3">&nbsp;</td>
	  <td>&nbsp;</td>
	  <td>&nbsp;</td>
  </tr>
	<tr>
	  <td colspan="3">&nbsp;</td>
	  <td>&nbsp;</td>
	  <td>&nbsp;</td>
  </tr>
	<tr>
	  <td colspan="3">&nbsp;</td>
	  <td>&nbsp;</td>
	  <td>&nbsp;</td>
  </tr>
	<tr>
	  <td colspan="3" style="text-decoration: underline;">Análisis del saldo</td>
	  <td>&nbsp;</td>
	  <td>&nbsp;</td>
  </tr>
	<tr>
	  <td colspan="3">&nbsp;</td>
	  <td>&nbsp;</td>
	  <td>&nbsp;</td>
  </tr>
	<tr>
	  <td colspan="3">Saldo según cartola del Banco </td>
	  <td>&nbsp;</td>
	  <td>$@ViewBag.SaldoCartola</td>
  </tr>
	<tr>
	  <td colspan="3">&nbsp;</td>
	  <td>&nbsp;</td>
	  <td>&nbsp;</td>
  </tr>
	<tr>
	  <td colspan="3">&nbsp;</td>
	  <td>&nbsp;</td>
	  <td>&nbsp;</td>
  </tr>
	<tr>
	  <td colspan="3">Cheques sin cobrar:</td>
	  <td>&nbsp;</td>
	  <td>&nbsp;</td>
  </tr>
	<tr>
	  <td colspan="3">&nbsp;</td>
	  <td>&nbsp;</td>
	  <td>&nbsp;</td>
  </tr>
	<tr>
	  <td style="text-decoration: underline; display: block;">FECHA&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</td>
	  <td style="text-decoration: underline; display: block;">CHEQUE&nbsp;&nbsp;&nbsp;&nbsp;</td>
	  <td style="text-decoration: underline; display: block;">NOMBRE&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</td>
	  <td>&nbsp;</td>
	  <td>&nbsp;</td>
  </tr>
    @foreach (var item in Model)
    {
        if (item.TipoComprobanteID == 2)
        {
            List<SAG2.Models.DetalleEgreso> detalles = db.DetalleEgreso.Where(d => d.MovimientoID == item.ID).ToList();
            foreach (var detalle in detalles)
            {
                bool conciliado = false;
                bool salto = true;

                try
                {
                    int detalleID = detalle.ID;
                    SAG2.Models.ConciliacionRegistro cr = db.ConciliacionRegistro.Where(c => c.DetalleID == detalleID).Single();

                   
                    
                    if (cr.Periodo < PeriodoSeleccionado)
                    {
                        continue;
                    }
                    else if (cr.Periodo == PeriodoSeleccionado && cr.Mes < mesSeleccionado)
                    {
                        continue;
                    }
                    
                    
                    if (cr.Mes > mesSeleccionado)
                    {
                        conciliado = false;
                    }
                    else
                    {
                        conciliado = true;
                    }
                    
                    if (cr.Periodo == PeriodoSeleccionado && cr.Mes == mesSeleccionado)
                    {
                        salto = false;
                    }
                    
                }
                catch (Exception)
                {
                    conciliado = false;
                }

                if (detalle.Conciliado != null && detalle.Conciliado.Equals("S") && !(item.Periodo == PeriodoSeleccionado && item.Mes == mesSeleccionado) && salto)
                {
                    continue;
                }
                
                if (conciliado)
                {
                    continue;
                }

                cantidad++;
	<tr>
	  <td align="left">@item.Fecha.Value.ToShortDateString()</td>
	  <td align="left">@Html.DisplayFor(modelItem => item.Cheque)</td>
	  <td>
        @if (item.Persona != null)
        {
            @Html.DisplayFor(modelItem => item.Persona.NombreCompleto)
        }
        else if (item.Proveedor != null)
        {
            @Html.DisplayFor(modelItem => item.Proveedor.Nombre)
        }
        else
        { 
            @Html.Raw(@item.Beneficiario)
        }
	  </td>
	  <td>$@Html.Raw(@detalle.Monto.ToString("#,##0"))</td>
	  <td>&nbsp;</td>
  </tr>
            }
        }
    }
	<tr>
	  <td>&nbsp;</td>
	  <td>&nbsp;</td>
	  <td>&nbsp;</td>
	  <td>&nbsp;</td>
	  <td>&nbsp;</td>
  </tr>
	<tr>
	  <td>&nbsp;</td>
	  <td>&nbsp;</td>
	  <td>&nbsp;</td>
	  <td>&nbsp;</td>
	  <td>&nbsp;</td>
  </tr>
	<tr>
	  <td>&nbsp;</td>
	  <td>&nbsp;</td>
	  <td>&nbsp;</td>
	  <td>&nbsp;</td>
	  <td>=SUMA(D18:@Html.Raw("D" + cantidad.ToString()+")")</td>
  </tr>
</table>
<p>&nbsp;</p>
    <p>&nbsp;</p>
    <p>&nbsp;</p>
<table cellspacing="0" cellpadding="0">
  <col width="93" />
  <col width="80" />
  <col width="289" />
  <col width="60" />
  <col width="104" />
  <tr>
    <td width="93" style="border-top: 1px solid black;">&nbsp;</td>
    <td width="80" style="border-top: 1px solid black;">&nbsp;</td>
    <td width="289"></td>
    <td width="60"></td>
    <td width="104" style="border-top: 1px solid black;">&nbsp;</td>
  </tr>
  <tr>
    <td colspan="4"><strong>SALDO ACREEDOR IGUAL MAYOR AL @ViewBag.Fecha</strong></td>
    <td><strong>=E12-@Html.Raw("E" + (cantidad+2).ToString())</strong></td>
  </tr>
  <tr>
    <td style="border-bottom: 1px solid black;">&nbsp;</td>
    <td style="border-bottom: 1px solid black;">&nbsp;</td>
    <td></td>
    <td></td>
    <td style="border-bottom: 1px solid black;">&nbsp;</td>
  </tr>
</table>
</body>
</html>
